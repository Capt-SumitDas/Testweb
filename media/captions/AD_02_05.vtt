WEBVTT

00:00:01.567 --> 00:00:04.700
Enumeration Through Service
Principal Names

00:00:05.796 --> 00:00:10.566
So far we have enumerated domain
users to find logged in user accounts

00:00:10.566 --> 00:00:12.833
that are members of high value groups.

00:00:13.244 --> 00:00:17.100
An alternative is to target so-called
service accounts

00:00:17.100 --> 00:00:20.600
which may also be members
of high value groups.

00:00:20.991 --> 00:00:24.694
When an application is executed,
it is always in the context

00:00:24.694 --> 00:00:27.500
of an operating system
user who launched it.

00:00:27.911 --> 00:00:31.200
However, services launched
by the system itself

00:00:31.200 --> 00:00:34.633
use the context based
on a Service Account.

00:00:35.005 --> 00:00:39.733
In other words, isolated applications
can use a set of predefined

00:00:39.733 --> 00:00:46.266
service accounts: LocalSystem,
LocalService, and NetworkService.

00:00:47.402 --> 00:00:52.222
For more complex applications, a domain
user account may be used to provide

00:00:52.222 --> 00:00:58.433
the needed context while still having
access to resources inside the domain.

00:00:58.883 --> 00:01:02.466
When applications like Exchange, SQL,

00:01:02.466 --> 00:01:06.566
or Internet Information Services
are integrated into Active Directory,

00:01:06.566 --> 00:01:14.900
a unique service instance identifier known
as a service principal name (SPN)…

00:01:15.272 --> 00:01:18.733
is used to associate a service
on a specific server

00:01:18.733 --> 00:01:21.766
to a service account in Active Directory.

00:01:22.706 --> 00:01:26.700
By enumerating all registered
SPNs in the domain,

00:01:26.700 --> 00:01:32.900
we can obtain the IP address and port
number of applications running on servers

00:01:32.900 --> 00:01:38.500
integrated with the Active Directory,
reducing the need for a broad port scan.

00:01:38.832 --> 00:01:42.533
Since the information is registered
and stored in Active Directory,

00:01:42.533 --> 00:01:45.266
it is present on the domain controller.

00:01:45.658 --> 00:01:49.566
To obtain this information, we
will again query the domain controller

00:01:49.566 --> 00:01:53.333
in search of specific
service principal names.

00:01:57.995 --> 00:02:01.566
Let’s update our PowerShell
enumeration script to filter

00:02:01.566 --> 00:02:05.333
the serviceprincipalname
property for the string

00:02:05.333 --> 00:02:10.900
*http*, indicating a registered
web server.

00:02:16.188 --> 00:02:20.166
Now we’ll run this updated
script and inspect the results.

00:02:27.864 --> 00:02:32.200
The search returns a number of results,
and although we could further filter them,

00:02:32.200 --> 00:02:35.300
we easily spot the
relevant information.

00:02:35.554 --> 00:02:38.600
One attribute name, samaccountname

00:02:38.600 --> 00:02:44.333
is set to iis_service, indicating
the presence of a web server,

00:02:45.253 --> 00:02:53.333
and serviceprincipalname is set to
 HTTP/CorpWebServer.corp.com.

00:02:54.253 --> 00:02:58.400
This all seems to suggest a
web server is part of the domain.

00:03:00.711 --> 00:03:05.833
Let’s attempt to resolve
“CorpWebServer.corp.com” with nslookup:

00:03:09.848 --> 00:03:14.100
The hostname resolves to
an internal IP address,

00:03:14.100 --> 00:03:18.100
which is also the IP address
of the domain controller.

00:03:18.961 --> 00:03:21.166
If we browse to this IP,

00:03:26.102 --> 00:03:29.400
we find a default IIS web server.

00:03:29.870 --> 00:03:32.933
A domain controller would
usually not host a web server,

00:03:32.933 --> 00:03:36.500
however, the lab is full of surprises.

00:03:42.552 --> 00:03:45.798
While the enumeration of service
principal names does not produce

00:03:45.798 --> 00:03:50.441
the web server software or version,
it will norrow the search and allow us

00:03:50.441 --> 00:03:56.200
to enumerate that information
manually or with focused port scans
