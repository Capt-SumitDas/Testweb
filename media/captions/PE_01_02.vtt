WEBVTT

00:00:01.525 --> 00:00:03.266
Listeners and Stagers

00:00:04.169 --> 00:00:08.766
We’ll begin our tour of Empire with a
brief discussion of listeners and stagers.

00:00:09.871 --> 00:00:11.866
As with Metasploit’s multi/handler,

00:00:11.866 --> 00:00:16.133
listeners accept inbound connections
from various Empire agents.

00:00:17.001 --> 00:00:20.866
Stagers are small pieces of code
generated by Empire

00:00:20.866 --> 00:00:24.966
that are executed on the victim
and connect back to a listener.

00:00:25.992 --> 00:00:29.033
They set up a connection
between the victim and the attacker

00:00:29.033 --> 00:00:32.366
 and perform additional tasks
to facilitate the transfer

00:00:32.366 --> 00:00:34.133
of a staged payload.

00:00:34.729 --> 00:00:39.266
To begin an Empire session,
we will first enter the listeners context.

00:00:42.615 --> 00:00:46.100
Then we’ll print available listeners with uselistener

00:00:46.100 --> 00:00:49.100
followed by a Space and a double Tab

00:00:49.100 --> 00:00:52.300
to engage Empire’s tab completion feature.

00:00:55.876 --> 00:01:00.200
The http listener is
the most basic listener,

00:01:00.200 --> 00:01:03.433
which communicates through
a series of HTTP GET

00:01:03.433 --> 00:01:08.333
and POST requests to
simulate legitimate HTTP traffic.

00:01:09.429 --> 00:01:11.166
Once we’ve decided on a listener,

00:01:11.166 --> 00:01:15.400
we can pass its name to the
uselistener command to select it.

00:01:17.687 --> 00:01:19.300
With our listener selected,

00:01:19.300 --> 00:01:23.533
we can run info to display
information and syntax.

00:01:26.022 --> 00:01:31.700
There are many available options,
but most are already set or are optional.

00:01:31.700 --> 00:01:36.100
The most important parameters are
Host and Port,

00:01:36.100 --> 00:01:39.833
which are used to set the
local IP address or hostname

00:01:39.833 --> 00:01:42.900
and the port number of the listener,
respectively.

00:01:44.539 --> 00:01:48.800
We can set the Host value
by running “set Host”

00:01:48.800 --> 00:01:51.100
followed by our local IP address.

00:01:52.432 --> 00:01:55.066
There are additional settings
worth noting.

00:01:56.837 --> 00:02:00.533
DefaultDelay sets the
wait interval callback time

00:02:00.533 --> 00:02:03.333
from the compromised host to the listener.

00:02:03.946 --> 00:02:08.366
This feature attempts to simulate
more legitimate HTTP traffic.

00:02:10.340 --> 00:02:15.433
The DefaultJitter setting
is a random offset to DefaultDelay

00:02:15.433 --> 00:02:19.766
designed to make the traffic seem
less programmatically generated.

00:02:21.521 --> 00:02:25.500
Setting KillDate will self-terminate
the listeners on all 

00:02:25.500 --> 00:02:28.633
compromised hosts on the specified date.

00:02:29.154 --> 00:02:33.966
This is especially useful when performing
cleanup after a penetration test.

00:02:34.533 --> 00:02:36.063
Once the options are set,

00:02:36.063 --> 00:02:39.633
we can start the listener
with the execute command.

00:02:43.471 --> 00:02:46.966
We can then return to the
main listener menu with back.

00:02:49.759 --> 00:02:54.239
Lastly, we can list all available stagers with usestager

00:02:54.239 --> 00:02:57.066
followed by a Space and two Tabs.

00:02:59.373 --> 00:03:04.333
Empire supports stagers for
Windows, Linux, and OS X.

00:03:04.818 --> 00:03:10.366
Windows stagers include support for 
standard DLLs, HTLM Applications, 

00:03:10.366 --> 00:03:12.333
Microsoft Office macros,

00:03:12.333 --> 00:03:16.633
and more exotic destinations such as
the USB Rubber Ducky.

00:03:17.038 --> 00:03:18.866
To get an idea of how this works,

00:03:18.866 --> 00:03:22.466
let’s try out the 
Windows BAT Launcher stager.

00:03:24.098 --> 00:03:25.604
After selecting the stager,

00:03:25.604 --> 00:03:28.700
we can review the options
with the info command.

00:03:34.309 --> 00:03:36.200
We can configure the Listener parameter

00:03:36.200 --> 00:03:41.333
with “set Listener” followed by
the name of the listener we just created.

00:03:43.631 --> 00:03:48.033
Finally, we’ll create the stager
with the execute command.

00:03:52.376 --> 00:03:55.033
To better understand the stager
we just created,

00:03:55.033 --> 00:03:58.800
let’s take a look at the generated
launcher.bat file.

00:04:03.252 --> 00:04:08.133
The stager is a base64-encoded
PowerShell command string.

00:04:08.466 --> 00:04:11.933
The first-stage payload
will connect to the listener


00:04:11.933 --> 00:04:15.533
and fetch the rest of the
Empire agent code.
